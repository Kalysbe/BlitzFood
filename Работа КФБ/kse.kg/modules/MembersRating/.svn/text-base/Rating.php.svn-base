<?php
$Module = "Rating";

function Rating_loadController() {
    $controller = new ControllerClass();

    $sql = "SELECT `date` FROM `members_rating_info` GROUP BY `date`";
    $result = mysql_query($sql);
    $rows = mysql_num_rows($result);
    $years = array();
    for ($i = 0; $i < $rows; $i++) {
        mysql_data_seek($result, $i);
        $obj = mysql_fetch_object($result);
        $date = explode("-", $obj->date);
        $years[] = $date[0];
    }
    $controller->appendVariable("available_years", $years);

    $uri = MainClass::getSingleton()->getFullUriPath();
    if (count($uri) == 4) {
        if (is_numeric(intval($uri[3]))) {
            $year = $uri[3] . "-00-00";
            $controller->appendVariable("current_year", $uri[3]);
        } 
    } else {
        $year = date("Y-00-00");
        $controller->appendVariable("current_year", date("Y"));
    }
    $sql = "SELECT
        CAST(`volume` AS UNSIGNED) AS `volume`,`amount`,`company_name_full`
    FROM `members_rating_info` WHERE (`date`='" . $year . "') ORDER BY `volume` DESC";
    $result = mysql_query($sql);
    $rows = mysql_num_rows($result);
    $rating = array();
    for ($i = 0; $i < $rows; $i++) {
        mysql_data_seek($result, $i);
        $info = mysql_fetch_object($result);
        $rating[$i]['name'] = $info->company_name_full;
        $rating[$i]['volume'] = round($info->volume / 1000000, 2);
        $rating[$i]['amount'] = $info->amount;
    }
    $controller->appendVariable("rating", $rating);
    $controller->appendVariable("ControllerInclusion", "modules/MembersRating/Rating.html");

    return $controller;
}
?>
