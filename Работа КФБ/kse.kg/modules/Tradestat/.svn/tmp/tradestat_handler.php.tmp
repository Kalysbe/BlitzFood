<?php

function Tradestat_getModuleBuffer() {

$query= "select ts.makedate(date0) as date1, sVolume, 
	www.GETDIFF(VolCng) as VolPicture, VolCng, smark,
	to_char(sTotal,'fm999G999G990D0000', 
	'nls_numeric_characters='', ''''') as sTotal, 
	www.GETDIFF(TotalCng) as TotalPicture, 
	to_char(TotalCng,'fm999G999G990D00', 'nls_numeric_characters='', ''''')
	as TotalCng, to_char(sRazm,'fm999G999G990D0000', 
	'nls_numeric_characters='', ''''') as sRazm, www.GETDIFF(RazmCng) 
	as RazmPicture, to_char(RazmCng,'fm999G999G990D00', 
	'nls_numeric_characters='', ''''') as RazmCng, 
	to_char(sSecond,'fm999G999G990D0000', 'nls_numeric_characters='', 
	''''') as sSecond, www.GETDIFF(SecondCng) as SecondPicture, 
	to_char(SecondCng,'fm999G999G990D00', 'nls_numeric_characters='', ''''')
	as SecondCng, to_char(sList,'fm999G999G990D0000', 
	'nls_numeric_characters='', ''''') as sList, www.GETDIFF(ListCng) 
	as ListPicture, to_char(ListCng,'fm999G999G990D00', 
	'nls_numeric_characters='', ''''') as ListCng, 
	to_char(sUnList,'fm999G999G990D0000', 'nls_numeric_characters='', 
	''''') as sUnList, www.GETDIFF(UnListCng) as UnListPicture, 
	to_char(UnListCng,'fm999G999G990D00', 'nls_numeric_characters='', 
	''''') as UnListCng 
	from (
		select
		date0,
		round(sum(t.volume)/2000000,1) as sVolume,
		round(www.prevvolume(t.date0),1) as VolCng,
		sum(t.PRICE / t.PRICE)/2 as sMark,
		round(sum(t.price*t.volume)/2000000,3) as sTotal,
		round(www.prevtotal(t.date0),1) as TotalCng,
		round(nvl(www.srazm(t.date0),0)/1000000,3) as sRazm,
		round(www.PREVRAZM(t.date0),1) as RazmCng,
		round(sum(t.price*t.volume)/2000000-nvl(www.srazm(t.date0),0)/1000000,3) as sSecond,
		round(www.prevsecond(t.date0),1) as SecondCng,
		round(nvl(www.slist(t.date0),0)/1000000,3) as sList,
		round(www.prevlist(t.date0),1) as ListCng,
		round(sum(t.price*t.volume)/2000000-nvl(www.slist(t.date0),0)/1000000,3) as sUnList,
		round(www.prevunlist(t.date0),1) as UnListCng
		from sys.deal2 t
		where t.date0=(select max(t1.date0) from sys.deal2 t1)
		group by t.date0)
";

    $query_ = "select * from
(
select tc.shortname as name, tc.namerus,ts.makedate(tc.zakdate),(case when ts.makedate(tc.zakdate) like '-' then '' else concat(', äàòà çàêðûòèÿ ',to_char(ts.makedate(tc.zakdate))) end) as dt,
       (select (max(ts.makeb(www.dot(round(price,2)), direct)))
       from ts.orders t where t.ownid=tc.ords_id) as b,
       (select sum(volume)
       from ts.orders t where t.ownid=tc.ords_id
       and t.price=(select max(ts.makeb(price, direct)) from ts.orders t where t.ownid=tc.ords_id)
       ) as bv,
       (select (min(ts.makes(www.dot(round(price,2)), direct)))
       from ts.orders t where t.ownid=tc.ords_id) as s,
       (select sum(volrest)
       from ts.orders t where t.ownid=tc.ords_id
       and t.price=(select min(ts.makes(price, direct)) from ts.orders t where t.ownid=tc.ords_id)
       ) as sv
  from ts.ts_currinstrument_arcts tc
 )
 where b is not null or s is not null";

    $conn = oci_connect("ts", "everytime", "192.168.0.26/TEST.mars.kase.kz", 
    "CL8MSWIN1251");
    if (!$conn) {
        $e = oci_error();
        trigger_error(htmlentities($e['message'], ENT_QUOTES), E_USER_ERROR);
    }

    $stid = oci_parse($conn, $query);
    if (!$stid) {
        $e = oci_error($conn);
        trigger_error(htmlentities($e['message'], ENT_QUOTES), E_USER_ERROR);
    }

    // Perform the logic of the query
    $r = oci_execute($stid);
    if (!$r) {
        $e = oci_error($stid);
        trigger_error(htmlentities($e['message'], ENT_QUOTES), E_USER_ERROR);
    }

    function FormatNum($num)
    {
            if (strlen($num) < 2)
                    return '0'.$num;
            else return $num;
    }

    $buffer = "";

    while ($row = oci_fetch_array($stid, OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS)) {
        $buf = array();
        foreach ($row as $k => $item) {
            //echo $k . "====>" . $item . "<br />";
            $buf[$k] = mb_convert_encoding($item, "UTF-8", "Windows-1251");
	}

	$buffer.= "
	<div class=\"center\">
	<h2>Itogi torgov " . $buf["DATE1"] . "</h2>
	<table class=\"class1\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">
		<tr>
		<td width=\"*\">&nbsp;</td>
		<td width=\"23%\">Mln. som</td>
		<td width=\"23%\">%</td>
		<td width=\"5%\">&nbsp;</td>
		</tr>
		<tr>
		<td>Volume</td>
		<td class=\"center\">" . $buf["STOTAL"] . "</td>
		<td class=\"center\">" . $buf["TOTALCNG"] . "</td>
		<td class=\"center\"></td>
		</tr>
		<tr>
		<td>Primary</td>
		<td class=\"center\">" . $buf["SRAZM"] . "</td>
		<td class=\"center\">" . $buf["RAZMCNG"] . "</td>
		<td class=\"center\"></td>
		</tr>
		<tr>
		<td>Secondary</td>
		<td class=\"center\">" . $buf["SSECOND"] . "</td>
		<td class=\"center\">" . $buf["SECONDCNG"] . "</td>
		<td class=\"center\"></td>
		</tr>
		<tr>
		<td>Listing</td>
		<td class=\"center\">" . $buf["SLIST"] . "</td>
		<td class=\"center\">" . $buf["LISTCNG"] . "</td>
		<td class=\"center\"></td>
		</tr>
		<tr>
		<td>Non Listing</td>
		<td class=\"center\">" . $buf["SUNLIST"] . "</td>
		<td class=\"center\">" . $buf["UNLISTCNG"] . "</td>
		<td class=\"center\"></td>
		</tr>
	</table>
	</div>
	";
	
        #$sql = "INSERT INTO `mod_tradestat_quatations` (`symbol`, `name`, `buy_amount`,
        #    `buy_price`, `sell_amount`, `sell_price`) VALUES ('" .
        #    $buffer["NAME"] . "', '" . $buffer["NAMERUS"] . "',
        #    '" . $buffer["BV"] . "', '" . $buffer["B"] . "', '" .
        #    $buffer["SV"] . "', '" . $buffer["S"] . "')";
        #mysql_query($sql);
    }
	return $buffer;

    return $query;
}

?>
